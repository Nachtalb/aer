<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
      :root {
        /* Typography */
        --palette-text-primary: #fff;
        --palette-text-secondary: rgba(255, 255, 255, 0.7);
        --palette-text-disabled: rgba(255, 255, 255, 0.5);

        /* Buttons */
        --palette-action-active: #fff;
        --palette-action-hover: rgba(255, 255, 255, 0.08);
        --palette-action-selected: rgba(255, 255, 255, 0.16);
        --palette-action-disabled: rgba(255, 255, 255, 0.3);
        --palette-action-disabledBackground: rgba(255, 255, 255, 0.12);

        /* Background */
        --palette-background-default: #121212;
        --palette-background-paper: #121212;

        /* Divider */
        --palette-divider: rgba(255, 255, 255, 0.12);

        /* Other */
        --item-width: 300px;
        --item-height: 250px;

        --padding: 8px;
      }

      body.dark {
      }

      * {
        box-sizing: border-box;
      }

      body {
        background-color: var(--palette-background-default);
        color: var(--palette-text-primary);
        font-family: FiraCode, Arial, Helvetica, sans-serif;
        margin: 0;
        padding: 0;
        position: relative;
      }

      img {
        width: 100%;
        object-fit: contain;
        max-height: 100%;
      }

      video {
        width: 100%;
        object-fit: contain;
        max-height: 100%;
      }

      audio {
        width: 100%;
      }

      #content {
        padding: var(--padding);
      }

      #gallery {
        display: grid;
        grid-gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(var(--item-width), 1fr));
        grid-auto-rows: var(--item-height);
      }

      .item {
        display: flex;
        justify-content: center;
        margin: 0 auto;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
        padding: var(--padding);
        transition: background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
        border-radius: 12px;
        border: 1px solid var(--palette-divider);
        background-color: var(--palette-background-paper);
        color: var(--palette-text-primary);
      }

      .item:hover {
        background-color: var(--palette-action-hover);
        border: 1px solid var(--palette-action-selected);
      }

      .media {
        overflow: hidden;
        display: flex;
        flex: 1;
      }

      .name {
        margin-top: 10px;
        color: var(--palette-text-secondary);
      }

      .btn {
        margin: 5px;
        border: none;
        cursor: pointer;
        background: transparent;
        padding: var(--padding);
        border-radius: 12px;

        transition: background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;

        color: var(--palette-text-secondary);
        font-size: 16px;
      }

      .btn:hover {
        background-color: var(--palette-action-hover);
      }

      .btn-download {
      }

      .btn-download:hover {
        background-color: var(--palette-action-hover);
      }

      .btn-copy {
      }

      .btn-copy:hover {
        background-color: var(--palette-action-hover);
      }

      .btn-open {
      }

      .btn-open:hover {
        background-color: var(--palette-action-hover);
      }

      .action-buttons {
        display: flex;
        justify-content: center;
      }

      #toast-container {
        position: fixed;
        bottom: var(--padding);
        right: 50%;
        transform: translateX(50%);
        z-index: 1000;
        display: flex;
        flex-direction: column;
      }

      .toast {
        color: var(--palette-text-primary);
        background-color: var(--palette-background-default);
        border-radius: 12px;
        margin-bottom: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        display: flex;
        flex: 1 1 auto;
        overflow: hidden;
      }

      .toast-inner {
        background-color: var(--palette-action-disabledBackground);
        width: 100%;
        height: 100%;
        padding: 10px 20px;
      }
    </style>
  </head>
  <body>
    <main id="content">
      <h1>Gallery</h1>
      <div id="gallery"></div>
    </main>

    <div id="toast-container"></div>
    <script>
      const toastContainer = document.querySelector("#toast-container");
      const gallery = document.querySelector("#gallery");
      const mediaPrefix = "http://localhost:9990/";
      const parser = new DOMParser();

      // Fetching all files
      fetch("/files")
        .then((response) => response.json())
        .then((files) => files.forEach(showFile));

      function showFile(file) {
        let mediaFile;

        switch (file.type_) {
          case "image":
            mediaFile = document.createElement("img");
            break;
          case "video":
            mediaFile = document.createElement("video");
            mediaFile.controls = true;
            break;
          case "audio":
            mediaFile = document.createElement("audio");
            mediaFile.controls = true;
            break;
          default:
            console.error("Unsupported file type", file.type_);
            return;
        }

        mediaFile.src = file.url;
        mediaFile.alt = file.name;

        const html = `
        <div class="item ${file.hash}">
          <div class="media">
            ${mediaFile.outerHTML}
          </div>
          <div class="name">${file.name}</div>
          <div class="action-buttons">
            <button class="btn btn-download"><i class="fa fa-download" aria-hidden="true"></i></button>
            <button class="btn btn-copy"><i class="fa fa-copy" aria-hidden="true"></i></button>
            <button class="btn btn-open"><i class="fa fa-external-link-alt" aria-hidden="true"></i></button>
          </div>
        </div>
        `;

        const item = parser.parseFromString(html, "text/html").body.firstChild;
        gallery.appendChild(item);
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text);

        showToast("Copied to clipboard");
      }

      function downloadFile(url) {
        const a = document.createElement("a");
        a.href = url;
        a.download = url.split("/").pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        showToast("Downloaded");
      }

      function openFile(url) {
        window.open(url, "_blank");

        showToast("Opened");
      }

      function showToast(message) {
        const toast = document.createElement("div");
        toast.classList.add("toast");
        const toastInner = document.createElement("div");
        toastInner.classList.add("toast-inner");
        toastInner.innerText = message;
        toast.appendChild(toastInner);
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 3000);
      }

      document.addEventListener("click", (event) => {
        let target = event.target;

        // if target is icon then get parent button
        if (target.classList.contains("fa")) {
          target = target.closest(".btn");
        }
        if (target.classList.contains("btn-download")) {
          const item = target.closest(".item");
          const media = item.querySelector(".media");
          const mediaFile = media.querySelector("img, video, audio");
          downloadFile(mediaFile.src);
        } else if (target.classList.contains("btn-copy")) {
          const item = target.closest(".item");
          const media = item.querySelector(".media");
          const mediaFile = media.querySelector("img, video, audio");
          copyToClipboard(mediaFile.src);
        } else if (target.classList.contains("btn-open")) {
          const item = target.closest(".item");
          const media = item.querySelector(".media");
          const mediaFile = media.querySelector("img, video, audio");
          openFile(mediaFile.src);
        }
      });
    </script>
  </body>
</html>
